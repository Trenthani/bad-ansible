---
# tasks file for win_ad_install
- name: install AD-Domain-Services
  win_feature:
    name: AD-Domain-Services
    state: present

- name: debug
  debug:
    var: ssh_host 

- name: domain name - error handling
  block:
    - name: domain name
      win_domain:
       dns_domain_name: "{{ ssh_host }}"
       safe_mode_password: "{{ ansible_password }}"
      register: domain_name_result
      ignore_errors: true

    - name: show status
      debug:
        var: domain_name_result.stderr
      when: domain_name_result.rc is 1

    - name: win reboot
      win_reboot:
       msg: reboot initiated by ansible
      when: domain_name_result.reboot is required
  rescue:
    - name: win reboot
      win_reboot:
       msg: reboot initiated by ansible
  always:
    - name: list domains test
      shell: nltest /dclist:"{{ ad_domain_name }}" 
      retries: 10
      delay: 5
  




